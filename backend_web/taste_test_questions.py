"""
음식 취향 테스트 질문 및 ABSA 매핑
- 간단 테스트: 8개 질문
- 심화 테스트: 20개 질문
- 5점 리커트 척도
"""

# 간단 테스트 질문 (8개)
QUICK_TEST_QUESTIONS = [
    # 축 1: 맛 성향 (2개)
    {
        "id": 1,
        "aspect": "매운맛",
        "question": "매운 음식을 좋아하시나요?",
        "labels": ["매우 싫어함", "싫어함", "보통", "좋아함", "매우 좋아함"],
        "absa_mapping": {
            1: {"매운맛_부정": 0.9, "매운맛_중립": 0.1},
            2: {"매운맛_부정": 0.6, "매운맛_중립": 0.3, "매운맛_긍정": 0.1},
            3: {"매운맛_중립": 0.7, "매운맛_긍정": 0.15, "매운맛_부정": 0.15},
            4: {"매운맛_긍정": 0.6, "매운맛_중립": 0.3, "매운맛_부정": 0.1},
            5: {"매운맛_긍정": 0.9, "매운맛_중립": 0.1}
        }
    },
    {
        "id": 2,
        "aspect": "담백함",
        "question": "담백하고 깔끔한 맛을 좋아하시나요?",
        "labels": ["매우 싫어함", "싫어함", "보통", "좋아함", "매우 좋아함"],
        "absa_mapping": {
            1: {"담백함_부정": 0.9, "담백함_중립": 0.1},
            2: {"담백함_부정": 0.6, "담백함_중립": 0.3, "담백함_긍정": 0.1},
            3: {"담백함_중립": 0.7, "담백함_긍정": 0.15, "담백함_부정": 0.15},
            4: {"담백함_긍정": 0.6, "담백함_중립": 0.3, "담백함_부정": 0.1},
            5: {"담백함_긍정": 0.9, "담백함_중립": 0.1}
        }
    },
    
    # 축 2: 음식 스타일 (2개)
    {
        "id": 3,
        "aspect": "품질/신선도",
        "question": "음식의 품질과 신선도가 중요한가요?",
        "labels": ["전혀 아님", "별로", "보통", "중요함", "매우 중요함"],
        "absa_mapping": {
            1: {"품질/신선도_부정": 0.3, "품질/신선도_중립": 0.7},
            2: {"품질/신선도_중립": 0.6, "품질/신선도_부정": 0.2, "품질/신선도_긍정": 0.2},
            3: {"품질/신선도_중립": 0.5, "품질/신선도_긍정": 0.5},
            4: {"품질/신선도_긍정": 0.7, "품질/신선도_중립": 0.3},
            5: {"품질/신선도_긍정": 0.95, "품질/신선도_중립": 0.05}
        }
    },
    {
        "id": 4,
        "aspect": "가격",
        "question": "가격 대비 만족도(가성비)가 중요한가요?",
        "labels": ["전혀 아님", "별로", "보통", "중요함", "매우 중요함"],
        "absa_mapping": {
            1: {"가격_중립": 0.8, "가격_부정": 0.2},
            2: {"가격_중립": 0.6, "가격_긍정": 0.2, "가격_부정": 0.2},
            3: {"가격_중립": 0.5, "가격_긍정": 0.5},
            4: {"가격_긍정": 0.7, "가격_중립": 0.3, "양_긍정": 0.3},
            5: {"가격_긍정": 0.9, "가격_중립": 0.1, "양_긍정": 0.5}
        }
    },
    
    # 축 3: 공간 성향 (2개)
    {
        "id": 5,
        "aspect": "분위기",
        "question": "식당의 분위기가 중요한가요?",
        "labels": ["전혀 아님", "별로", "보통", "중요함", "매우 중요함"],
        "absa_mapping": {
            1: {"분위기_중립": 0.8, "분위기_부정": 0.2},
            2: {"분위기_중립": 0.7, "분위기_긍정": 0.15, "분위기_부정": 0.15},
            3: {"분위기_중립": 0.5, "분위기_긍정": 0.5},
            4: {"분위기_긍정": 0.7, "분위기_중립": 0.3, "쾌적함/청결도_긍정": 0.4},
            5: {"분위기_긍정": 0.95, "분위기_중립": 0.05, "쾌적함/청결도_긍정": 0.7}
        }
    },
    {
        "id": 6,
        "aspect": "주차",
        "question": "주차 공간이나 접근성이 중요한가요?",
        "labels": ["전혀 아님", "별로", "보통", "중요함", "매우 중요함"],
        "absa_mapping": {
            1: {"주차_중립": 0.8, "주차_부정": 0.2},
            2: {"주차_중립": 0.7, "주차_긍정": 0.15, "주차_부정": 0.15},
            3: {"주차_중립": 0.7, "주차_긍정": 0.3},
            4: {"주차_긍정": 0.7, "주차_중립": 0.3},
            5: {"주차_긍정": 0.9, "주차_중립": 0.1}
        }
    },
    
    # 축 4: 서비스 성향 (2개)
    {
        "id": 7,
        "aspect": "서비스",
        "question": "직원의 친절한 서비스가 중요한가요?",
        "labels": ["전혀 아님", "별로", "보통", "중요함", "매우 중요함"],
        "absa_mapping": {
            1: {"서비스_중립": 0.8, "서비스_부정": 0.2},
            2: {"서비스_중립": 0.7, "서비스_긍정": 0.15, "서비스_부정": 0.15},
            3: {"서비스_중립": 0.6, "서비스_긍정": 0.4},
            4: {"서비스_긍정": 0.7, "서비스_중립": 0.3},
            5: {"서비스_긍정": 0.95, "서비스_중립": 0.05}
        }
    },
    {
        "id": 8,
        "aspect": "대기",
        "question": "대기 시간이 길어도 괜찮으신가요?",
        "labels": ["절대 안됨", "싫음", "보통", "괜찮음", "상관없음"],
        "absa_mapping": {
            1: {"대기_부정": 0.9, "대기_중립": 0.1},
            2: {"대기_부정": 0.6, "대기_중립": 0.3, "대기_긍정": 0.1},
            3: {"대기_중립": 0.7, "대기_긍정": 0.15, "대기_부정": 0.15},
            4: {"대기_긍정": 0.5, "대기_중립": 0.4, "대기_부정": 0.1},
            5: {"대기_긍정": 0.8, "대기_중립": 0.2}
        }
    }
]


# 심화 테스트 질문 (20개 = 간단 8개 + 추가 12개)
DEEP_TEST_ADDITIONAL_QUESTIONS = [
    # 맛 성향 추가 3개
    {
        "id": 9,
        "aspect": "짠맛",
        "question": "짠 음식을 좋아하시나요?",
        "labels": ["매우 싫어함", "싫어함", "보통", "좋아함", "매우 좋아함"],
        "absa_mapping": {
            1: {"짠맛_부정": 0.9, "짠맛_중립": 0.1},
            2: {"짠맛_부정": 0.6, "짠맛_중립": 0.3, "짠맛_긍정": 0.1},
            3: {"짠맛_중립": 0.7, "짠맛_긍정": 0.15, "짠맛_부정": 0.15},
            4: {"짠맛_긍정": 0.6, "짠맛_중립": 0.3, "짠맛_부정": 0.1},
            5: {"짠맛_긍정": 0.9, "짠맛_중립": 0.1}
        }
    },
    {
        "id": 10,
        "aspect": "단맛",
        "question": "단 음식을 좋아하시나요?",
        "labels": ["매우 싫어함", "싫어함", "보통", "좋아함", "매우 좋아함"],
        "absa_mapping": {
            1: {"단맛_부정": 0.9, "단맛_중립": 0.1},
            2: {"단맛_부정": 0.6, "단맛_중립": 0.3, "단맛_긍정": 0.1},
            3: {"단맛_중립": 0.7, "단맛_긍정": 0.15, "단맛_부정": 0.15},
            4: {"단맛_긍정": 0.6, "단맛_중립": 0.3, "단맛_부정": 0.1},
            5: {"단맛_긍정": 0.9, "단맛_중립": 0.1}
        }
    },
    {
        "id": 11,
        "aspect": "고소함",
        "question": "고소한 맛을 좋아하시나요?",
        "labels": ["매우 싫어함", "싫어함", "보통", "좋아함", "매우 좋아함"],
        "absa_mapping": {
            1: {"고소함_부정": 0.9, "고소함_중립": 0.1},
            2: {"고소함_부정": 0.6, "고소함_중립": 0.3, "고소함_긍정": 0.1},
            3: {"고소함_중립": 0.7, "고소함_긍정": 0.15, "고소함_부정": 0.15},
            4: {"고소함_긍정": 0.6, "고소함_중립": 0.3, "고소함_부정": 0.1},
            5: {"고소함_긍정": 0.9, "고소함_중립": 0.1}
        }
    },
    
    # 음식 스타일 추가 3개
    {
        "id": 12,
        "aspect": "양",
        "question": "음식의 양이 많은 것을 선호하시나요?",
        "labels": ["적을수록", "적당히 적게", "보통", "많게", "매우 많게"],
        "absa_mapping": {
            1: {"양_부정": 0.5, "양_중립": 0.5},
            2: {"양_중립": 0.6, "양_부정": 0.2, "양_긍정": 0.2},
            3: {"양_중립": 0.7, "양_긍정": 0.3},
            4: {"양_긍정": 0.7, "양_중립": 0.3},
            5: {"양_긍정": 0.9, "양_중립": 0.1}
        }
    },
    {
        "id": 13,
        "aspect": "맛",
        "question": "음식의 전반적인 맛이 가장 중요한가요?",
        "labels": ["전혀 아님", "별로", "보통", "중요함", "매우 중요함"],
        "absa_mapping": {
            1: {"맛_중립": 0.8, "맛_부정": 0.2},
            2: {"맛_중립": 0.6, "맛_긍정": 0.2, "맛_부정": 0.2},
            3: {"맛_중립": 0.4, "맛_긍정": 0.6},
            4: {"맛_긍정": 0.8, "맛_중립": 0.2},
            5: {"맛_긍정": 0.95, "맛_중립": 0.05}
        }
    },
    {
        "id": 14,
        "aspect": "느끼함",
        "question": "느끼한 음식은 어떠신가요?",
        "labels": ["싫어함", "별로", "보통", "좋아함", "매우 좋아함"],
        "absa_mapping": {
            1: {"느끼함_부정": 0.9, "느끼함_중립": 0.1},
            2: {"느끼함_부정": 0.6, "느끼함_중립": 0.3, "느끼함_긍정": 0.1},
            3: {"느끼함_중립": 0.7, "느끼함_긍정": 0.15, "느끼함_부정": 0.15},
            4: {"느끼함_긍정": 0.6, "느끼함_중립": 0.3, "느끼함_부정": 0.1},
            5: {"느끼함_긍정": 0.9, "느끼함_중립": 0.1}
        }
    },
    
    # 공간 성향 추가 3개
    {
        "id": 15,
        "aspect": "쾌적함/청결도",
        "question": "식당의 청결도가 중요한가요?",
        "labels": ["전혀 아님", "별로", "보통", "중요함", "매우 중요함"],
        "absa_mapping": {
            1: {"쾌적함/청결도_중립": 0.8, "쾌적함/청결도_부정": 0.2},
            2: {"쾌적함/청결도_중립": 0.6, "쾌적함/청결도_긍정": 0.2, "쾌적함/청결도_부정": 0.2},
            3: {"쾌적함/청결도_중립": 0.4, "쾌적함/청결도_긍정": 0.6},
            4: {"쾌적함/청결도_긍정": 0.8, "쾌적함/청결도_중립": 0.2},
            5: {"쾌적함/청결도_긍정": 0.95, "쾌적함/청결도_중립": 0.05}
        }
    },
    {
        "id": 16,
        "aspect": "소음",
        "question": "시끄러운 식당은 어떠신가요?",
        "labels": ["매우 싫음", "싫음", "보통", "괜찮음", "상관없음"],
        "absa_mapping": {
            1: {"소음_부정": 0.9, "소음_중립": 0.1},
            2: {"소음_부정": 0.6, "소음_중립": 0.3, "소음_긍정": 0.1},
            3: {"소음_중립": 0.7, "소음_긍정": 0.15, "소음_부정": 0.15},
            4: {"소음_긍정": 0.5, "소음_중립": 0.4, "소음_부정": 0.1},
            5: {"소음_긍정": 0.8, "소음_중립": 0.2}
        }
    },
    {
        "id": 17,
        "aspect": "공간",
        "question": "공간이 넓은 식당을 선호하시나요?",
        "labels": ["아니요", "별로", "보통", "예", "매우 예"],
        "absa_mapping": {
            1: {"공간_부정": 0.5, "공간_중립": 0.5},
            2: {"공간_중립": 0.6, "공간_부정": 0.2, "공간_긍정": 0.2},
            3: {"공간_중립": 0.7, "공간_긍정": 0.3},
            4: {"공간_긍정": 0.7, "공간_중립": 0.3},
            5: {"공간_긍정": 0.9, "공간_중립": 0.1}
        }
    },
    
    # 서비스 성향 추가 3개
    {
        "id": 18,
        "aspect": "서비스",
        "question": "직원의 응대 속도가 중요한가요?",
        "labels": ["전혀 아님", "별로", "보통", "중요함", "매우 중요함"],
        "absa_mapping": {
            1: {"서비스_중립": 0.8, "서비스_부정": 0.2},
            2: {"서비스_중립": 0.7, "서비스_긍정": 0.15, "서비스_부정": 0.15},
            3: {"서비스_중립": 0.6, "서비스_긍정": 0.4},
            4: {"서비스_긍정": 0.7, "서비스_중립": 0.3},
            5: {"서비스_긍정": 0.9, "서비스_중립": 0.1}
        }
    },
    {
        "id": 19,
        "aspect": "맛",
        "question": "직원의 메뉴 추천을 받는 것을 선호하시나요?",
        "labels": ["싫어함", "별로", "보통", "좋아함", "매우 좋아함"],
        "absa_mapping": {
            1: {"서비스_부정": 0.5, "서비스_중립": 0.5},
            2: {"서비스_중립": 0.6, "서비스_부정": 0.2, "서비스_긍정": 0.2},
            3: {"서비스_중립": 0.7, "서비스_긍정": 0.3},
            4: {"서비스_긍정": 0.6, "서비스_중립": 0.4},
            5: {"서비스_긍정": 0.8, "서비스_중립": 0.2}
        }
    },
    {
        "id": 20,
        "aspect": "가격",
        "question": "조금 비싸더라도 프리미엄 서비스를 받고 싶으신가요?",
        "labels": ["아니요", "별로", "보통", "예", "매우 예"],
        "absa_mapping": {
            1: {"가격_긍정": 0.8, "가격_중립": 0.2, "서비스_중립": 0.5},
            2: {"가격_긍정": 0.6, "가격_중립": 0.3, "서비스_중립": 0.4, "가격_부정": 0.1},
            3: {"가격_중립": 0.6, "가격_긍정": 0.2, "서비스_긍정": 0.3, "가격_부정": 0.2},
            4: {"가격_부정": 0.4, "가격_중립": 0.3, "서비스_긍정": 0.6, "가격_긍정": 0.3},
            5: {"가격_부정": 0.6, "가격_중립": 0.2, "서비스_긍정": 0.9, "가격_긍정": 0.2}
        }
    }
]


# 심화 테스트 = 간단 + 추가
DEEP_TEST_QUESTIONS = QUICK_TEST_QUESTIONS + DEEP_TEST_ADDITIONAL_QUESTIONS


def answers_to_absa(answers: list, test_type: str = "quick") -> dict:
    """
    사용자 답변을 ABSA 특징으로 변환
    
    Args:
        answers: [1, 2, 3, 4, 5, ...] 형태의 답변 리스트 (각 값은 1-5)
        test_type: 'quick' or 'deep'
    
    Returns:
        dict: ABSA 특징 (51개 aspect-sentiment 확률)
    """
    questions = QUICK_TEST_QUESTIONS if test_type == "quick" else DEEP_TEST_QUESTIONS
    
    if len(answers) != len(questions):
        raise ValueError(f"답변 개수({len(answers)})와 질문 개수({len(questions)})가 일치하지 않습니다")
    
    # 모든 ABSA 키 초기화
    absa_features = {}
    
    # 각 답변을 ABSA로 변환하여 누적
    for answer, question in zip(answers, questions):
        if answer < 1 or answer > 5:
            raise ValueError(f"답변 값은 1-5 사이어야 합니다: {answer}")
        
        mapping = question["absa_mapping"][answer]
        for key, value in mapping.items():
            if key in absa_features:
                absa_features[key] += value
            else:
                absa_features[key] = value
    
    # 평균 계산 (여러 질문에서 같은 aspect를 다룰 수 있으므로)
    # 단, 정규화는 하지 않고 그대로 반환 (최대값 보정)
    
    return absa_features


def calculate_mbti_type(absa_features: dict) -> str:
    """
    ABSA 특징으로부터 MBTI 스타일 타입 계산
    
    4개 축:
    - S (Spicy/Strong) vs M (Mild): 강렬한 맛 vs 부드러운 맛
    - Q (Quality) vs V (Value): 품질 중시 vs 가성비 중시
    - A (Atmosphere) vs C (Convenience): 분위기 중시 vs 편의성 중시
    - F (Friendly) vs I (Independent): 서비스 중시 vs 독립적
    
    Returns:
        str: 4글자 타입 (예: "SQAF", "MVCI")
    """
    # 축 1: 맛 성향
    spicy_score = absa_features.get("매운맛_긍정", 0) + absa_features.get("짠맛_긍정", 0)
    mild_score = absa_features.get("담백함_긍정", 0) + absa_features.get("단맛_긍정", 0)
    axis1 = "S" if spicy_score > mild_score else "M"
    
    # 축 2: 음식 스타일
    quality_score = absa_features.get("품질/신선도_긍정", 0) + absa_features.get("맛_긍정", 0)
    value_score = absa_features.get("가격_긍정", 0) + absa_features.get("양_긍정", 0)
    axis2 = "Q" if quality_score > value_score else "V"
    
    # 축 3: 공간 성향
    atmosphere_score = absa_features.get("분위기_긍정", 0) + absa_features.get("쾌적함/청결도_긍정", 0)
    convenience_score = absa_features.get("주차_긍정", 0) + absa_features.get("대기_긍정", 0)
    axis3 = "A" if atmosphere_score > convenience_score else "C"
    
    # 축 4: 서비스 성향
    friendly_score = absa_features.get("서비스_긍정", 0)
    independent_score = absa_features.get("서비스_부정", 0) + absa_features.get("서비스_중립", 0)
    axis4 = "F" if friendly_score > independent_score else "I"
    
    return f"{axis1}{axis2}{axis3}{axis4}"


# MBTI 타입별 설명
MBTI_TYPE_DESCRIPTIONS = {
    "SQAF": {
        "name": "미식가 감성파",
        "description": "강렬한 맛을 즐기며, 고급 재료와 멋진 분위기, 친절한 서비스를 중시하는 타입",
        "recommendations": ["파인다이닝 레스토랑", "감성 카페", "프리미엄 맛집"]
    },
    "SQAI": {
        "name": "품격있는 미식가",
        "description": "품질과 분위기를 중시하지만, 서비스보다는 음식 자체에 집중하는 타입",
        "recommendations": ["조용한 고급 레스토랑", "품질 중심 맛집", "분위기 좋은 술집"]
    },
    "SQCF": {
        "name": "실용적 미식가",
        "description": "품질 좋은 음식과 친절한 서비스를 원하지만, 접근성도 중요하게 생각하는 타입",
        "recommendations": ["동네 맛집", "품질 좋은 프랜차이즈", "친절한 가게"]
    },
    "SQCI": {
        "name": "맛집 헌터",
        "description": "강렬한 맛과 품질을 최우선으로, 접근성 좋은 곳이라면 어디든 찾아가는 타입",
        "recommendations": ["숨은 맛집", "로컬 맛집", "품질 최우선 식당"]
    },
    "SVAF": {
        "name": "감성 외식러",
        "description": "강한 맛과 가성비, 좋은 분위기와 서비스를 모두 원하는 균형잡힌 타입",
        "recommendations": ["분위기 좋은 맛집", "가성비 좋은 감성 카페", "SNS 핫플"]
    },
    "SVAI": {
        "name": "분위기 중시형",
        "description": "맛과 가성비, 분위기는 중요하지만 혼자 조용히 즐기는 것을 선호",
        "recommendations": ["혼밥 카페", "분위기 좋은 술집", "조용한 맛집"]
    },
    "SVCF": {
        "name": "합리적 외식러",
        "description": "강한 맛과 가성비, 편의성과 친절한 서비스를 중시하는 실속형",
        "recommendations": ["가성비 맛집", "동네 맛집", "편한 분위기 식당"]
    },
    "SVCI": {
        "name": "효율적 미식가",
        "description": "맛과 가성비, 접근성을 최우선으로 빠르게 식사하는 타입",
        "recommendations": ["가성비 맛집", "배달 맛집", "빠른 식당"]
    },
    "MQAF": {
        "name": "우아한 식도락가",
        "description": "부드러운 맛과 품질, 멋진 분위기와 서비스를 중시하는 세련된 타입",
        "recommendations": ["고급 레스토랑", "브런치 카페", "프리미엄 디저트 카페"]
    },
    "MQAI": {
        "name": "조용한 미식가",
        "description": "담백한 맛과 품질, 분위기를 중시하며 혼자만의 시간을 즐기는 타입",
        "recommendations": ["조용한 카페", "품질 좋은 일식당", "분위기 좋은 와인바"]
    },
    "MQCF": {
        "name": "편안한 미식가",
        "description": "담백한 맛과 품질, 편의성과 친절함을 중시하는 균형잡힌 타입",
        "recommendations": ["동네 맛집", "편한 카페", "친절한 식당"]
    },
    "MQCI": {
        "name": "건강 지향형",
        "description": "담백하고 품질 좋은 음식, 접근성을 중시하는 건강한 식사 추구형",
        "recommendations": ["샐러드 전문점", "건강식 레스토랑", "웰빙 카페"]
    },
    "MVAF": {
        "name": "가족 외식러",
        "description": "부드러운 맛, 가성비, 편의성과 친절한 서비스를 모두 중시하는 가족 외식형",
        "recommendations": ["가족 레스토랑", "뷔페", "친절한 한식당"]
    },
    "MVAI": {
        "name": "혼밥 마스터",
        "description": "담백한 맛과 가성비, 분위기를 중시하며 혼자 식사를 즐기는 타입",
        "recommendations": ["혼밥 맛집", "조용한 카페", "분위기 좋은 식당"]
    },
    "MVCF": {
        "name": "실속 외식러",
        "description": "담백한 맛, 가성비, 편의성, 서비스를 모두 고려하는 가장 균형잡힌 타입",
        "recommendations": ["동네 맛집", "가성비 한식당", "편한 카페"]
    },
    "MVCI": {
        "name": "실속 혼밥러",
        "description": "담백한 맛, 가성비, 편의성을 중시하며 혼자 조용히 먹는 것을 선호",
        "recommendations": ["배달 맛집", "편의점", "간단한 식사"]
    }
}







